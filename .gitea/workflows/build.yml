name: build
on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]
env:
  REGISTRY_USER: ${{ github.actor }}
  REGISTRY_PASSWORD: ${{ secrets.REGISTRY_TOKEN }}
  IMAGE_REGISTRY: git.saintnet.tech/${{ github.repository_owner }}
  MISE_ENV: ci
jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - uses: jdx/mise-action@v2
        with:
          # version: "latest" # [default: latest] mise version to install
          install: true # [default: true] run `mise install`
          cache: true # [default: true] cache mise using GitHub's cache
          experimental: true # [default: false] enable experimental features
      - name: Setup qemu
        run: "docker run --rm --privileged multiarch/qemu-user-static --reset -p yes"
      - name: Login to registry
        uses: docker/login-action@v3
        with:
          registry: git.saintnet.tech
          username: ${{ gitea.actor }}
          password: ${{ secrets.REGISTRY_TOKEN }}
      - name: Build container
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "TAG=${{ github.event.pull_request.title }}" >> $GITHUB_ENV
            export TAG=${{ github.event.pull_request.title }}
          else
            export TAG=latest
          fi
          mise ci
      - name: Logout registry
        run: docker logout git.saintnet.tech
