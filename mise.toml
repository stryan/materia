[tools]
age = "latest"
go = "1.24"
"go:golang.org/x/tools/cmd/stringer" = "latest"
golangci-lint = "2.0.2"
gotestsum = "latest"

[settings]
experimental = true

[tasks]

[tasks.container]
depends = ["build","lint","test"]
run = 'podman build -f Containerfile.ci  -t git.saintnet.tech/stryan/materia:latest .'

[tasks.build]
depends = ["generate","build-arm64","build-amd64"]

[tasks.lint]
run = "golangci-lint run ./cmd/... ./internal/..."

[tasks.virter-age]
run = [
	"age -r age1s2sc3dz0vrcmungswpxwnett7ayvzmfuke8vw0w3te36l742kpqs6kg606 scripts/vm/testrepo/secrets/vault.toml > scripts/vm/testrepo/secrets/vault.age",
	"age -r age1s2sc3dz0vrcmungswpxwnett7ayvzmfuke8vw0w3te36l742kpqs6kg606 scripts/vm/testrepo/secrets/localhost.toml > scripts/vm/testrepo/secrets/localhost.age",
	"age -r age1s2sc3dz0vrcmungswpxwnett7ayvzmfuke8vw0w3te36l742kpqs6kg606 scripts/vm/testrepo/secrets/base.toml > scripts/vm/testrepo/secrets/base.age",
]

[tasks.test]
depends = ["generate"]
run = [
	"age -r age1s2sc3dz0vrcmungswpxwnett7ayvzmfuke8vw0w3te36l742kpqs6kg606 scripts/testrepo/secrets/vault.toml > scripts/testrepo/secrets/vault.age",
	"age -r age1s2sc3dz0vrcmungswpxwnett7ayvzmfuke8vw0w3te36l742kpqs6kg606 scripts/testrepo/secrets/localhost.toml > scripts/testrepo/secrets/localhost.age",
	"gotestsum ./scripts/",
]


[tasks.virter-test]
depends = ['build-amd64','lint','test',"virter-age"]
env = {	REPO = 'file:///tmp/testrepo' }
run = [
	"if virter vm exists materia-test-alma-9; then virter vm rm materia-test-alma-9; fi",
	"virter vm run --name materia-test-alma-9 --id 0 --wait-ssh alma-9",
	"virter vm exec materia-test-alma-9 --provision ./scripts/virter_provision.toml --set values.Repo=$REPO --set values.RemoteHost=$MATERIA_TEST_REPO_HOST",
	"virter vm rm materia-test-alma-9",
]

[tasks.generate]
description = "Run go:generate"
sources = ["go.mod", "go.sum", "**/*.go"]
outputs = { auto = true }
run = "go generate ./..."

[tasks.build-arm64]
depends = ["generate"]
description = "Build the project for arm64"
sources = ["go.mod", "go.sum", "**/*.go"]
outputs = ["./bin/materia-arm64"]
env = { GOOS="linux", GOARCH="arm64", CGO_ENABLED=0 }
run = "go build -o bin/materia-arm64 ./cmd/materia/"


[tasks.build-amd64]
depends = ["generate"]
description = "Build the project for amd64"
sources = ["go.mod", "go.sum", "**/*.go"]
outputs = ["./bin/materia-amd64"]
env = { GOOS="linux", GOARCH="amd64", CGO_ENABLED=0 }
run = "go build -o bin/materia-amd64 ./cmd/materia/"

